<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ±‚äººä¸€è¦§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - äººæç´¹ä»‹ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="sheets-api-config.js"></script>
    <!-- GAS é€£æºãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆCORSâ†’ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ -->
    <script src="config.js"></script>
    <script src="gas-connector.js"></script>
    <script src="gas-form-submit.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        /* Harmosé¢¨ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
        :root {
            --primary-blue: #2563eb;      /* ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ«ãƒ¼ */
            --secondary-blue: #1d4ed8;    /* ãƒ€ãƒ¼ã‚¯ãƒ–ãƒ«ãƒ¼ */
            --light-blue: #3b82f6;        /* ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ */
            --accent-blue: #0ea5e9;       /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆãƒ–ãƒ«ãƒ¼ */
            --bg-blue: #eff6ff;           /* èƒŒæ™¯ãƒ–ãƒ«ãƒ¼ */
            --text-dark: #1e293b;         /* ãƒ€ãƒ¼ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ */
            --text-gray: #64748b;         /* ã‚°ãƒ¬ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ */
            --border-gray: #e2e8f0;       /* ãƒœãƒ¼ãƒ€ãƒ¼ */
            --bg-white: #ffffff;
            --bg-gray: #f8fafc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', Roboto, sans-serif;
            background: var(--bg-gray);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-dark);
        }
        
        .container {
            max-width: 95vw;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }
        
        .header {
            background: var(--primary-blue);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 8px 0;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
            font-weight: 400;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: var(--bg-white);
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-settings {
            background: var(--bg-blue);
            border: 1px solid #bfdbfe;
        }
        
        .ai-settings .section-title {
            color: var(--primary-blue);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--bg-white);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary-blue);
            color: white;
            border: 1px solid var(--primary-blue);
        }
        
        .btn-primary:hover {
            background: var(--secondary-blue);
            border-color: var(--secondary-blue);
        }
        
        .btn-secondary {
            background: var(--bg-white);
            color: var(--primary-blue);
            border: 1px solid var(--border-gray);
        }
        
        .btn-secondary:hover {
            background: var(--bg-gray);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }
        
        .btn-outline:hover {
            background: var(--primary-blue);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            border: 1px solid var(--danger);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .file-drop-zone {
            border: 2px dashed var(--border-gray);
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            background: var(--bg-gray);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .file-drop-zone.drag-over {
            border-color: var(--primary-blue);
            background: var(--bg-blue);
        }
        
        .file-drop-zone.processing {
            border-color: var(--accent-blue);
            background: var(--bg-blue);
        }
        
        .file-drop-zone input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-drop-zone h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: var(--text-dark);
        }
        
        .file-drop-zone p {
            margin: 0;
            color: var(--text-gray);
            font-size: 14px;
        }
        
        .processing-status {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            display: none;
        }
        
        .processing-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f59e0b;
        }
        
        .processing-item:last-child {
            border-bottom: none;
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-blue);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-white);
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-gray);
            margin: 0;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-gray);
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-white);
            min-width: 1400px;
        }
        
        .table th {
            background: var(--bg-gray);
            color: var(--text-dark);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid var(--border-gray);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--border-gray);
            vertical-align: top;
            font-size: 14px;
        }
        
        .table tr:hover {
            background: var(--bg-gray);
        }
        
        .editable-cell {
            cursor: text;
            position: relative;
        }
        
        .editable-cell:hover {
            background: var(--bg-blue);
        }
        
        .editable-cell input, 
        .editable-cell select, 
        .editable-cell textarea {
            border: none;
            background: transparent;
            width: 100%;
            padding: 4px 8px;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
        }
        
        .editable-cell textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }
        
        .status-not-sent { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .status-sent { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .status-applied { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .status-interview { background: #fffbeb; color: #d97706; border: 1px solid #fed7aa; }
        .status-rejected { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        
        .ai-badge {
            background: var(--primary-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }
        
        .confidence-score {
            font-size: 11px;
            color: var(--text-gray);
            font-style: italic;
            margin-top: 2px;
        }
        
        .file-list {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-gray);
            border-radius: 8px;
            border: 1px solid var(--border-gray);
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin: 8px 0;
            background: var(--bg-white);
            border-radius: 6px;
            border: 1px solid var(--border-gray);
        }
        
        .prompt-editor {
            margin-top: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .prompt-textarea {
            width: 100%;
            margin-top: 8px;
            padding: 12px;
            border: 1px solid var(--border-gray);
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            background: var(--bg-white);
            resize: vertical;
        }
        
        .info-text {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 8px;
            line-height: 1.4;
        }
        
        .section-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIæ±‚äººä¸€è¦§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>AIãŒPDFã‹ã‚‰æ±‚äººæƒ…å ±ã‚’è‡ªå‹•æŠ½å‡ºã—ã¾ã™</p>
        </div>
        
        <div class="content">
            <!-- AIè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section ai-settings">
                <h3 class="section-title">ğŸ§  AIè¨­å®š</h3>
                <p style="margin: 0 0 16px 0;">AIè§£æã¯ã‚µãƒ¼ãƒå´ï¼ˆGASï¼‰ã§å®Ÿæ–½ã—ã¾ã™ã€‚ã‚­ãƒ¼å…¥åŠ›ã¯ä¸è¦ã§ã™ã€‚</p>
                <input type="password" id="apiKey" class="form-input" placeholder="ä¸è¦ï¼ˆç®¡ç†å´ã§è¨­å®šæ¸ˆã¿ï¼‰" disabled />
                
                <div style="margin-top: 16px;">
                    <button class="btn btn-outline" onclick="togglePromptEditor()">
                        ğŸ¯ AIè§£æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†
                    </button>
                    
                    <div id="promptEditor" class="prompt-editor" style="display: none;">
                        <label style="color: var(--primary-blue); font-size: 14px; font-weight: 500;">ğŸ“ ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</label>
                        <textarea id="customPrompt" rows="8" class="prompt-textarea" placeholder="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã™..."></textarea>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary" onclick="resetPrompt()">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                            <button class="btn btn-outline" onclick="testPrompt()">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚¹ãƒˆ</button>
                        </div>
                    </div>
                </div>
                
                <div class="info-text">
                    â€» OpenAIã‚­ãƒ¼ã¯ã‚µãƒ¼ãƒå´ã§ç®¡ç†ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ä¸è¦ï¼‰<br>
                    â€» GPT-4oä½¿ç”¨ã§é«˜ç²¾åº¦ãªæŠ½å‡ºãŒå¯èƒ½ï¼ˆ1PDF = ç´„0.5-2å††ï¼‰
                </div>
            </div>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h3 class="section-title">ğŸ“ æ±‚äººPDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <div class="file-drop-zone" id="dropZone">
                    <div style="pointer-events: none;">
                        <h4>ğŸ¤– AIãŒè‡ªå‹•ã§æ±‚äººæƒ…å ±ã‚’æŠ½å‡º</h4>
                        <p>PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯é¸æŠã—ã¦ãã ã•ã„</p>
                        <p style="color: var(--text-gray); font-size: 12px; margin-top: 8px;">PDFã€Wordã€ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ | é«˜ç²¾åº¦AIåˆ†æ</p>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                </div>
                
                <!-- å‡¦ç†çŠ¶æ³ -->
                <div id="processingStatus" class="processing-status">
                    <h4 style="margin: 0 0 12px 0; color: var(--warning);">ğŸ”„ AIå‡¦ç†ä¸­...</h4>
                    <div id="processingItems"></div>
                </div>
                
                <div id="fileList" class="file-list" style="display: none;">
                    <h4 style="margin: 0 0 16px 0; color: var(--text-dark);">ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰äºˆå®šãƒ•ã‚¡ã‚¤ãƒ«:</h4>
                    <div id="fileItems"></div>
                    <button class="btn btn-primary" onclick="processFilesWithAI()" style="margin-top: 16px;">
                        ğŸ¤– AIã§æ±‚äººæƒ…å ±ã‚’è‡ªå‹•æŠ½å‡º
                    </button>
                </div>
            </div>

            <!-- çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="stats-grid" id="statsSection">
                <div class="stat-card">
                    <div class="stat-number" id="totalJobs">0</div>
                    <p class="stat-label">ç·æ±‚äººæ•°</p>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="notSentJobs">0</div>
                    <p class="stat-label">æœªé€ä»˜</p>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="sentJobs">0</div>
                    <p class="stat-label">é€ä»˜æ¸ˆã¿</p>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="appliedJobs">0</div>
                    <p class="stat-label">å¿œå‹Ÿæ¸ˆã¿</p>
                </div>
            </div>

            <!-- æ±‚äººä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="section">
                <div class="table-header">
                    <h3 class="section-title">ğŸ“‹ æ±‚äººä¸€è¦§</h3>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="addNewJob()">â• æ‰‹å‹•ã§æ±‚äººã‚’è¿½åŠ </button>
                        <button class="btn btn-outline" onclick="exportToCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
                        <button class="btn btn-primary" onclick="saveAllJobsToSpreadsheet()">ğŸ’¾ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table" id="jobTable">
                        <thead>
                            <tr>
                                <th style="width: 180px;">æ±‚äººå</th>
                                <th style="width: 140px;">ä¼šç¤¾å</th>
                                <th style="width: 120px;">å¹´å</th>
                                <th style="width: 140px;">å‹¤å‹™åœ°</th>
                                <th style="width: 100px;">åœŸæ—¥ä¼‘ã¿</th>
                                <th style="width: 100px;">å¹´é–“ä¼‘æ—¥</th>
                                <th style="width: 200px;">å¿œå‹Ÿæ¡ä»¶</th>
                                <th style="width: 120px;">æ‹…å½“è€…</th>
                                <th style="width: 120px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th style="width: 200px;">å‚™è€ƒ</th>
                                <th style="width: 80px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="jobTableBody">
                            <!-- AIã§æŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.jsè¨­å®š
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let jobData = [];
        let jobIdCounter = 1;
        // GASé€£æºã®åˆæœŸåŒ–
        let gasConnector;
        let formSubmitter;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            // GASé€£æºï¼ˆCONFIG ãŒã‚ã‚Œã°åˆæœŸåŒ–ï¼‰
            if (typeof CONFIG !== 'undefined') {
                const GAS_URL = GASUtils.getGASUrl();
                gasConnector = new GASConnector(GAS_URL);
                formSubmitter = new GASFormSubmitter(GAS_URL);
                console.log('GASé€£æºãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ:', GAS_URL);
            } else {
                console.warn('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚config.jsã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });
        // APIã‚­ãƒ¼ã¯ä¸è¦ï¼ˆGASå´åˆ©ç”¨ï¼‰

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            fileInput.files = e.dataTransfer.files;
            displayFileList();
        });

        fileInput.addEventListener('change', displayFileList);

        function displayFileList() {
            const files = fileInput.files;
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');
            
            if (files.length === 0) {
                fileList.style.display = 'none';
                return;
            }

            fileList.style.display = 'block';
            fileItems.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span>ğŸ“„ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)</span>
                    <button class="btn btn-danger" onclick="removeFile(${i})" style="padding: 6px 12px; font-size: 12px;">å‰Šé™¤</button>
                `;
                fileItems.appendChild(fileItem);
            }
        }

        function removeFile(index) {
            const dt = new DataTransfer();
            const files = fileInput.files;
            
            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }
            
            fileInput.files = dt.files;
            displayFileList();
        }

        async function processFilesWithAI() {
            const files = fileInput.files;
            if (files.length === 0) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const processingStatus = document.getElementById('processingStatus');
            const processingItems = document.getElementById('processingItems');
            
            processingStatus.style.display = 'block';
            dropZone.classList.add('processing');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                await processFileWithAI(file, processingItems);
            }

            // å‡¦ç†å®Œäº†
            processingStatus.style.display = 'none';
            dropZone.classList.remove('processing');
            fileInput.value = '';
            document.getElementById('fileList').style.display = 'none';
            
            updateStats();
            alert(`${files.length}ä»¶ã®æ±‚äººã‚’AIã§è§£æãƒ»è¿½åŠ ã—ã¾ã—ãŸï¼`);
        }

        async function processFileWithAI(file, processingContainer) {
            // å‡¦ç†çŠ¶æ³è¡¨ç¤º
            const processingItem = document.createElement('div');
            processingItem.className = 'processing-item';
            processingItem.innerHTML = `
                <div class="spinner"></div>
                <span id="status-${file.name}">ğŸ“„ ${file.name} ã‚’è§£æä¸­...</span>
            `;
            processingContainer.appendChild(processingItem);

            try {
                let extractedText = '';

                if (file.type === 'application/pdf') {
                    // PDFå‡¦ç†
                    document.getElementById(`status-${file.name}`).textContent = `ğŸ“„ ${file.name} ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºä¸­...`;
                    extractedText = await extractTextFromPDF(file);
                } else {
                    // ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆç”»åƒãªã©ï¼‰ã®å ´åˆ
                    extractedText = `ãƒ•ã‚¡ã‚¤ãƒ«å: ${file.name}\nãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)}MB\nâ€»ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã€OCRæ©Ÿèƒ½ãŒå¿…è¦ã§ã™`;
                }

                // AIè§£æ
                document.getElementById(`status-${file.name}`).textContent = `ğŸ¤– ${file.name} ã‚’AIã§è§£æä¸­...`;
                const jobInfo = await analyzeWithOpenAI(extractedText);
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
                addJobToTable(jobInfo, file.name);
                
                document.getElementById(`status-${file.name}`).textContent = `âœ… ${file.name} ã®è§£æå®Œäº†ï¼`;
                
            } catch (error) {
                console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById(`status-${file.name}`).textContent = `âŒ ${file.name} ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ`;
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                const fallbackJob = {
                    jobTitle: `æ±‚äºº_${file.name}`,
                    company: 'ä¼šç¤¾åä¸æ˜',
                    salary: 'å¹´åä¸æ˜',
                    location: 'å‹¤å‹™åœ°ä¸æ˜',
                    weekendOff: 'unknown',
                    annualHolidays: 'ä¸æ˜',
                    requirements: 'æ¡ä»¶ä¸æ˜',
                    confidence: 0.1
                };
                addJobToTable(fallbackJob, file.name);
            }
        }

        async function extractTextFromPDF(file) {
            return new Promise((resolve, reject) => {
                const fileReader = new FileReader();
                fileReader.onload = async function() {
                    try {
                        const typedArray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedArray).promise;
                        let fullText = '';

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            const pageText = textContent.items.map(item => item.str).join(' ');
                            fullText += pageText + '\n';
                        }

                        resolve(fullText);
                    } catch (error) {
                        reject(error);
                    }
                };
                fileReader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'));
                fileReader.readAsArrayBuffer(file);
            });
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        const defaultPrompt = `ã‚ãªãŸã¯æ—¥æœ¬ã®æ±‚äººç¥¨è§£æã®å°‚é–€å®¶ã§ã™ã€‚ä»¥ä¸‹ã®æ±‚äººç¥¨ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æƒ…å ±ã‚’æ­£ç¢ºã«æŠ½å‡ºã—ã€JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

## æŠ½å‡ºãƒ«ãƒ¼ãƒ«ï¼š
1. æ±‚äººã‚¿ã‚¤ãƒˆãƒ«ï¼šã€Œå‹Ÿé›†è·ç¨®ã€ã€Œè·ç¨®åã€ã€Œãƒã‚¸ã‚·ãƒ§ãƒ³ã€ãªã©ã‹ã‚‰æŠ½å‡º
2. ä¼šç¤¾åï¼šæ ªå¼ä¼šç¤¾ã€æœ‰é™ä¼šç¤¾ã€åˆåŒä¼šç¤¾ãªã©ã®æ³•äººæ ¼ã‚‚å«ã‚ã‚‹
3. å¹´åï¼šã€Œå¹´åã€ã€Œçµ¦ä¸ã€ã€Œæœˆçµ¦Ã—12+è³ä¸ã€ã§è¨ˆç®—ã€‚ç¯„å›²ã§è¨˜è¼‰ï¼ˆä¾‹ï¼š400-500ä¸‡å††ï¼‰
4. å‹¤å‹™åœ°ï¼šéƒ½é“åºœçœŒåã¯å¿…é ˆã€å¸‚åŒºç”ºæ‘ã‚‚å¯èƒ½ãªé™ã‚ŠæŠ½å‡º
5. åœŸæ—¥ä¼‘ã¿ï¼šã€ŒåœŸæ—¥ç¥ä¼‘ã¿ã€ã€Œå®Œå…¨é€±ä¼‘2æ—¥åˆ¶ã€â†’yesã€ã€Œã‚·ãƒ•ãƒˆåˆ¶ã€ã€Œå¹´é–“ä¼‘æ—¥â—‹â—‹æ—¥ã®ã¿è¨˜è¼‰ã€â†’no
6. å¹´é–“ä¼‘æ—¥ï¼šæ˜è¨˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æ•°å€¤æŠ½å‡ºï¼ˆä¾‹ï¼š125æ—¥ï¼‰
7. å¿œå‹Ÿæ¡ä»¶ï¼šå­¦æ­´ãƒ»çµŒé¨“ãƒ»è³‡æ ¼ãƒ»ã‚¹ã‚­ãƒ«ãªã©ç°¡æ½”ã«ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰
8. ç¢ºä¿¡åº¦ï¼šæƒ…å ±ã®æ˜ç¢ºã•ã«åŸºã¥ã0.3-1.0ã§è©•ä¾¡

## å‡ºåŠ›JSONå½¢å¼ï¼š
{
  "jobTitle": "å…·ä½“çš„ãªè·ç¨®å",
  "company": "æ­£å¼ãªä¼šç¤¾å",
  "salary": "å¹´åãƒ¬ãƒ³ã‚¸ï¼ˆä¸‡å††è¡¨è¨˜ï¼‰",
  "location": "éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘",
  "weekendOff": "yes/no/unknown",
  "annualHolidays": "æ•°å€¤+æ—¥ï¼ˆä¾‹ï¼š125æ—¥ï¼‰",
  "requirements": "å¿œå‹Ÿæ¡ä»¶ã‚’ç°¡æ½”ã«",
  "confidence": 0.0-1.0
}

## åˆ†æå¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆï¼š
{TEXT_PLACEHOLDER}

å¿…ãšJSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚`;

        function getCustomPrompt() {
            const customPrompt = document.getElementById('customPrompt').value;
            return customPrompt || defaultPrompt;
        }

        function togglePromptEditor() {
            const editor = document.getElementById('promptEditor');
            const promptTextarea = document.getElementById('customPrompt');
            
            if (editor.style.display === 'none') {
                editor.style.display = 'block';
                if (!promptTextarea.value) {
                    promptTextarea.value = defaultPrompt;
                }
            } else {
                editor.style.display = 'none';
            }
        }

        function resetPrompt() {
            document.getElementById('customPrompt').value = defaultPrompt;
            alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ');
        }

        function testPrompt() {
            const prompt = getCustomPrompt();
            const sampleText = "è·ç¨®ï¼šWebãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼\nä¼šç¤¾åï¼šæ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«\nå¹´åï¼š400-500ä¸‡å††\nå‹¤å‹™åœ°ï¼šæ±äº¬éƒ½æ¸‹è°·åŒº\nä¼‘æ—¥ï¼šåœŸæ—¥ç¥æ—¥ä¼‘ã¿\nå¹´é–“ä¼‘æ—¥ï¼š125æ—¥\nå¿œå‹Ÿæ¡ä»¶ï¼šWebãƒ‡ã‚¶ã‚¤ãƒ³çµŒé¨“3å¹´ä»¥ä¸Š";
            const finalPrompt = prompt.replace('{TEXT_PLACEHOLDER}', sampleText);
            
            alert('ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:\n\n' + finalPrompt.substring(0, 500) + '...');
        }

        async function analyzeWithOpenAI(text) {
            const promptTemplate = getCustomPrompt();
            try {
                const result = await gasConnector.sendRequest('aiExtract', { text, prompt: promptTemplate });
                return {
                    jobTitle: result.jobTitle || 'æ±‚äººæƒ…å ±',
                    company: result.company || '',
                    salary: result.salary || '',
                    location: result.location || '',
                    weekendOff: result.weekendOff || 'unknown',
                    annualHolidays: result.annualHolidays || '',
                    requirements: result.requirements || '',
                    confidence: typeof result.confidence === 'number' ? result.confidence : 0.8
                };
            } catch (error) {
                console.error('AIæŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
                return {
                    jobTitle: 'æ±‚äººæƒ…å ±',
                    company: 'AIè§£æå¤±æ•—',
                    salary: 'ä¸æ˜',
                    location: 'ä¸æ˜',
                    weekendOff: 'unknown',
                    annualHolidays: 'ä¸æ˜',
                    requirements: 'ä¸æ˜',
                    confidence: 0.1
                };
            }
        }

        function addJobToTable(jobInfo, fileName) {
            const jobId = 'ai_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-job-id', jobId);
            newRow.innerHTML = `
                <td class="editable-cell" data-field="jobTitle">
                    ${jobInfo.jobTitle}
                    <span class="ai-badge">AI</span>
                    <div class="confidence-score">ç¢ºä¿¡åº¦: ${Math.round(jobInfo.confidence * 100)}%</div>
                </td>
                <td class="editable-cell" data-field="company">${jobInfo.company}</td>
                <td class="editable-cell" data-field="salary">${jobInfo.salary}</td>
                <td class="editable-cell" data-field="location">${jobInfo.location}</td>
                <td class="editable-cell" data-field="weekendOff">
                    <select onchange="updateJobData(this)" class="form-input" style="padding: 8px;">
                        <option value="yes" ${jobInfo.weekendOff === 'yes' ? 'selected' : ''}>ã‚ã‚Š</option>
                        <option value="no" ${jobInfo.weekendOff === 'no' ? 'selected' : ''}>ãªã—</option>
                        <option value="unknown" ${jobInfo.weekendOff === 'unknown' ? 'selected' : ''}>ä¸æ˜</option>
                    </select>
                </td>
                <td class="editable-cell" data-field="annualHolidays">${jobInfo.annualHolidays}</td>
                <td class="editable-cell" data-field="requirements">${jobInfo.requirements}</td>
                <td class="editable-cell" data-field="assignedTo">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="æ‹…å½“è€…å" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="status">
                    <select onchange="updateJobData(this)" class="form-input" style="padding: 8px;">
                        <option value="not-sent" selected>æœªé€ä»˜</option>
                        <option value="sent">é€ä»˜æ¸ˆã¿</option>
                        <option value="applied">å¿œå‹Ÿæ¸ˆã¿</option>
                        <option value="interview">é¢æ¥ä¸­</option>
                        <option value="rejected">è¦‹é€ã‚Š</option>
                    </select>
                </td>
                <td class="editable-cell" data-field="notes">
                    <textarea onchange="updateJobData(this)" class="form-input" placeholder="å‚™è€ƒãƒ»ãƒ¡ãƒ¢" style="padding: 8px;">å…ƒãƒ•ã‚¡ã‚¤ãƒ«: ${fileName}</textarea>
                </td>
                <td>
                    <button class="btn btn-danger" onclick="deleteJob(this)" style="padding: 6px 12px; font-size: 12px;">å‰Šé™¤</button>
                </td>
            `;
            
            document.getElementById('jobTableBody').appendChild(newRow);
        }

        function addNewJob() {
            const jobId = 'manual_' + Date.now();
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-job-id', jobId);
            newRow.innerHTML = `
                <td class="editable-cell" data-field="jobTitle">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="æ±‚äººå" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="company">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="ä¼šç¤¾å" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="salary">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="å¹´å" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="location">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="å‹¤å‹™åœ°" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="weekendOff">
                    <select onchange="updateJobData(this)" class="form-input" style="padding: 8px;">
                        <option value="unknown" selected>ä¸æ˜</option>
                        <option value="yes">ã‚ã‚Š</option>
                        <option value="no">ãªã—</option>
                    </select>
                </td>
                <td class="editable-cell" data-field="annualHolidays">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="å¹´é–“ä¼‘æ—¥" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="requirements">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="å¿œå‹Ÿæ¡ä»¶" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="assignedTo">
                    <input type="text" onchange="updateJobData(this)" class="form-input" placeholder="æ‹…å½“è€…å" style="padding: 8px;">
                </td>
                <td class="editable-cell" data-field="status">
                    <select onchange="updateJobData(this)" class="form-input" style="padding: 8px;">
                        <option value="not-sent" selected>æœªé€ä»˜</option>
                        <option value="sent">é€ä»˜æ¸ˆã¿</option>
                        <option value="applied">å¿œå‹Ÿæ¸ˆã¿</option>
                        <option value="interview">é¢æ¥ä¸­</option>
                        <option value="rejected">è¦‹é€ã‚Š</option>
                    </select>
                </td>
                <td class="editable-cell" data-field="notes">
                    <textarea onchange="updateJobData(this)" class="form-input" placeholder="å‚™è€ƒãƒ»ãƒ¡ãƒ¢" style="padding: 8px;"></textarea>
                </td>
                <td>
                    <button class="btn btn-danger" onclick="deleteJob(this)" style="padding: 6px 12px; font-size: 12px;">å‰Šé™¤</button>
                </td>
            `;
            
            document.getElementById('jobTableBody').appendChild(newRow);
            updateStats();
        }

        async function updateJobData(element) {
            updateStats();
            
            // Google Sheetsã«è‡ªå‹•ä¿å­˜
            try {
                await saveCurrentJobData();
            } catch (error) {
                console.warn('æ±‚äººãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }
        
        // æ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’Google Sheetsã«ä¿å­˜
        async function saveCurrentJobData() {
            if (typeof saveJobListingData !== 'function') {
                console.log('Google Sheets API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            
            const rows = document.querySelectorAll('#jobTableBody tr');
            const savePromises = [];
            
            rows.forEach(row => {
                const jobData = extractJobDataFromRow(row);
                if (jobData.title && jobData.company) { // æœ€ä½é™ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ä¿å­˜
                    savePromises.push(saveJobListingData(jobData));
                }
            });
            
            if (savePromises.length > 0) {
                await Promise.all(savePromises);
                console.log(`${savePromises.length}ä»¶ã®æ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
            }
        }
        
        // è¡Œã‹ã‚‰æ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
        function extractJobDataFromRow(row) {
            const getFieldValue = (fieldName) => {
                const cell = row.querySelector(`[data-field="${fieldName}"]`);
                if (!cell) return '';
                
                const input = cell.querySelector('input, select, textarea');
                if (input) {
                    return input.value || '';
                }
                return cell.textContent?.trim() || '';
            };
            
            return {
                title: getFieldValue('jobTitle'),
                company: getFieldValue('company'),
                department: '',
                location: getFieldValue('location'),
                salaryMin: getFieldValue('salary').split('-')[0]?.trim() || '',
                salaryMax: getFieldValue('salary').split('-')[1]?.trim() || '',
                employmentType: 'æ­£ç¤¾å“¡',
                workStyle: 'é€šå¸¸å‹¤å‹™',
                requirements: getFieldValue('requirements'),
                skills: '',
                benefits: '',
                description: getFieldValue('notes'),
                applicationDeadline: '',
                startDate: '',
                clientContact: getFieldValue('assignedTo'),
                fee: '',
                priority: 'ä¸­',
                aiConfidence: getFieldValue('confidence') || '',
                aiExtracted: 'true',
                source: 'pdf_upload',
                notes: getFieldValue('notes'),
                weekendOff: getFieldValue('weekendOff'),
                annualHolidays: getFieldValue('annualHolidays')
            };
        }

        function deleteJob(button) {
            if (confirm('ã“ã®æ±‚äººã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                button.closest('tr').remove();
                updateStats();
            }
        }

        function updateStats() {
            const rows = document.querySelectorAll('#jobTableBody tr');
            const stats = {
                total: rows.length,
                notSent: 0,
                sent: 0,
                applied: 0
            };

            rows.forEach(row => {
                const statusSelect = row.querySelector('[data-field="status"] select');
                if (statusSelect) {
                    const status = statusSelect.value;
                    switch(status) {
                        case 'not-sent': stats.notSent++; break;
                        case 'sent': stats.sent++; break;
                        case 'applied': stats.applied++; break;
                    }
                }
            });

            document.getElementById('totalJobs').textContent = stats.total;
            document.getElementById('notSentJobs').textContent = stats.notSent;
            document.getElementById('sentJobs').textContent = stats.sent;
            document.getElementById('appliedJobs').textContent = stats.applied;
        }

        function exportToCSV() {
            const rows = document.querySelectorAll('#jobTableBody tr');
            let csv = 'æ±‚äººå,ä¼šç¤¾å,å¹´å,å‹¤å‹™åœ°,åœŸæ—¥ä¼‘ã¿,å¹´é–“ä¼‘æ—¥,å¿œå‹Ÿæ¡ä»¶,æ‹…å½“è€…,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,å‚™è€ƒ\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                for (let i = 0; i < cells.length - 1; i++) {
                    const cell = cells[i];
                    let value = '';
                    
                    // AIãƒãƒƒã‚¸ã‚„ç¢ºä¿¡åº¦ã‚’é™¤å¤–
                    const input = cell.querySelector('input, select, textarea');
                    if (input) {
                        value = input.value;
                    } else {
                        value = cell.textContent.replace(/AIç¢ºä¿¡åº¦:.*%/g, '').trim();
                    }
                    
                    rowData.push(`"${value}"`);
                }
                
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `AIæ±‚äººä¸€è¦§_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ===== GASé€£æºä¿å­˜ï¼ˆCORSâ†’ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ =====

        async function saveJobToSpreadsheet(row) {
            try {
                const jobInfo = extractJobDataFromRow(row);
                console.log('æ±‚äººãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹:', jobInfo);

                if (!gasConnector || !formSubmitter) {
                    console.warn('GASé€£æºãŒæœªåˆæœŸåŒ–ã§ã™ã€‚config.js ã® GAS_URL ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                GASUtils.showProgress('æ±‚äººãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­...');

                let result;
                try {
                    // ã¾ãšCORSã§è©¦è¡Œ
                    result = await gasConnector.saveJobListing(jobInfo);
                    console.log('CORSä¿å­˜æˆåŠŸ:', result);
                } catch (corsError) {
                    console.warn('CORSå¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§å†è©¦è¡Œ:', corsError);
                    GASUtils.showProgress('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§å†è©¦è¡Œä¸­...');
                    // CORSå¤±æ•—æ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§å†è©¦è¡Œ
                    result = await formSubmitter.submitData('saveJobListing', jobInfo);
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æˆåŠŸ:', result);
                }

                GASUtils.showProgress('æ±‚äººãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                addSavedIndicator(row);

                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ­ã‚°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§CORSå›é¿ï¼‰
                try {
                    await formSubmitter.submitData('logActivity', {
                        action: 'AIæ±‚äººãƒ‡ãƒ¼ã‚¿ä¿å­˜',
                        details: `æ±‚äººã€Œ${jobInfo.title}ã€ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜`,
                        userId: 'ai-job-manager',
                        url: window.location.href
                    });
                } catch (logError) {
                    console.warn('ãƒ­ã‚°è¨˜éŒ²ã¯çœç•¥:', logError);
                }

                return result;

            } catch (error) {
                console.error('æ±‚äººä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                GASUtils.showError(error);
                throw error;
            }
        }

        function addSavedIndicator(row) {
            const existing = row.querySelector('.saved-indicator');
            if (existing) existing.remove();
            const indicator = document.createElement('span');
            indicator.className = 'saved-indicator';
            indicator.innerHTML = 'âœ… ä¿å­˜æ¸ˆã¿';
            indicator.style.cssText = `
                background: #28a745;
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
                margin-left: 5px;
            `;
            const firstCell = row.querySelector('td');
            if (firstCell) firstCell.appendChild(indicator);
        }

        async function saveAllJobsToSpreadsheet() {
            const rows = document.querySelectorAll('#jobTableBody tr');
            if (rows.length === 0) {
                alert('ä¿å­˜ã™ã‚‹æ±‚äººãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (!confirm(`${rows.length}ä»¶ã®æ±‚äººã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const row of rows) {
                try {
                    await saveJobToSpreadsheet(row);
                    successCount++;
                    await new Promise(r => setTimeout(r, 100));
                } catch (e) {
                    console.error('è¡Œä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                    errorCount++;
                }
            }

            alert(`ä¿å­˜å®Œäº†: æˆåŠŸ ${successCount}ä»¶, ã‚¨ãƒ©ãƒ¼ ${errorCount}ä»¶`);
        }
    </script>
</body>
</html>
